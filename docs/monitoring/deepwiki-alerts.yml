# DeepWiki Alert Rules for Prometheus

groups:
  - name: deepwiki_disk_alerts
    interval: 30s
    rules:
      # Warning alert at 70% disk usage
      - alert: DeepWikiDiskUsageWarning
        expr: deepwiki_disk_usage_percent > 70
        for: 5m
        labels:
          severity: warning
          service: deepwiki
          team: infrastructure
        annotations:
          summary: "DeepWiki disk usage is at {{ $value | humanize }}%"
          description: "Disk usage on DeepWiki pod has exceeded 70% threshold. Current usage: {{ $value | humanize }}%"
          runbook_url: "https://wiki.internal/deepwiki-disk-cleanup"
          suggested_action: "Consider running cleanup job or increasing disk space"

      # Critical alert at 85% disk usage
      - alert: DeepWikiDiskUsageCritical
        expr: deepwiki_disk_usage_percent > 85
        for: 2m
        labels:
          severity: critical
          service: deepwiki
          team: infrastructure
          pager: true
        annotations:
          summary: "CRITICAL: DeepWiki disk usage is at {{ $value | humanize }}%"
          description: "Disk usage on DeepWiki pod has exceeded 85% threshold. Immediate action required!"
          runbook_url: "https://wiki.internal/deepwiki-disk-cleanup"
          suggested_action: "Run emergency cleanup: kubectl exec -n codequal-dev deployment/deepwiki -- /cleanup.sh"

      # Alert on cleanup failures
      - alert: DeepWikiCleanupFailures
        expr: rate(deepwiki_cleanup_failed_count[5m]) > 0
        for: 10m
        labels:
          severity: warning
          service: deepwiki
          team: infrastructure
        annotations:
          summary: "DeepWiki cleanup operations are failing"
          description: "{{ $value | humanize }} cleanup failures per second detected"
          runbook_url: "https://wiki.internal/deepwiki-cleanup-troubleshooting"

      # Alert on rapid disk growth
      - alert: DeepWikiRapidDiskGrowth
        expr: rate(deepwiki_disk_used_gb[5m]) > 0.5
        for: 5m
        labels:
          severity: warning
          service: deepwiki
          team: infrastructure
        annotations:
          summary: "DeepWiki disk usage growing rapidly"
          description: "Disk usage is increasing at {{ $value | humanize }} GB per minute"
          suggested_action: "Check for stuck analyses or unusually large repositories"

      # Alert on no cleanup activity when disk is high
      - alert: DeepWikiNoCleanupActivity
        expr: deepwiki_disk_usage_percent > 60 and rate(deepwiki_cleanup_success_count[30m]) == 0
        for: 30m
        labels:
          severity: warning
          service: deepwiki
          team: infrastructure
        annotations:
          summary: "No cleanup activity detected with high disk usage"
          description: "Disk usage is at {{ $value | humanize }}% but no cleanups have occurred in 30 minutes"
          suggested_action: "Check if cleanup job is scheduled and running properly"

  - name: deepwiki_analysis_alerts
    interval: 30s
    rules:
      # Alert on analysis failures
      - alert: DeepWikiAnalysisFailureRate
        expr: rate(deepwiki_analysis_failures_total[5m]) > 0.1
        for: 10m
        labels:
          severity: warning
          service: deepwiki
          team: engineering
        annotations:
          summary: "High DeepWiki analysis failure rate"
          description: "{{ $value | humanizePercentage }} of analyses are failing"
          suggested_action: "Check logs for error patterns"

      # Alert on stuck analyses
      - alert: DeepWikiStuckAnalysis
        expr: deepwiki_active_repositories > 5
        for: 1h
        labels:
          severity: warning
          service: deepwiki
          team: engineering
        annotations:
          summary: "Possible stuck analyses detected"
          description: "{{ $value }} repositories have been active for over 1 hour"
          suggested_action: "Check for hanging analysis processes"