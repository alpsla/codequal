#!/usr/bin/env bash

# Pre-commit Git Hook for CodeQual Regression Testing
# 
# This hook runs comprehensive regression tests before allowing commits
# to ensure critical functionality is not broken.
#
# To install:
#   cp packages/agents/scripts/git-hooks/pre-commit .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit

echo "üîç CodeQual: Running pre-commit regression validation..."
echo "=================================================="

# Get current working directory  
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

# Check if regression test suite exists
REGRESSION_SCRIPT="$REPO_ROOT/packages/agents/scripts/run-pre-commit-regression.js"

if [ ! -f "$REGRESSION_SCRIPT" ]; then
    echo "‚ö†Ô∏è  Regression test script not found at: $REGRESSION_SCRIPT"
    echo "   Skipping regression tests (not recommended)"
    echo "   Run: npm run setup:regression-tests to install"
    exit 0
fi

# Run the regression test suite
echo "üöÄ Executing comprehensive regression tests..."
node "$REGRESSION_SCRIPT"

REGRESSION_EXIT_CODE=$?

# Handle results
if [ $REGRESSION_EXIT_CODE -eq 0 ]; then
    echo ""
    echo "‚úÖ All regression tests passed!"
    echo "   ‚úì Core functionality preserved" 
    echo "   ‚úì Dynamic model selection working"
    echo "   ‚úì Scoring system (5/3/1/0.5) intact"
    echo "   ‚úì Report generator v7 functional"
    echo "   ‚úì Multi-language support verified"
    echo ""
    echo "üéâ Commit approved - proceeding..."
    exit 0
else
    echo ""
    echo "‚ùå REGRESSION TESTS FAILED!"
    echo "=================================================="
    echo ""
    echo "üö® CRITICAL: Your changes have broken existing functionality"
    echo ""
    echo "üìã Next steps:"
    echo "   1. Review the test failures above"
    echo "   2. Fix the broken functionality" 
    echo "   3. Run tests locally: npm run test:regression"
    echo "   4. Commit again once tests pass"
    echo ""
    echo "üîß Quick fixes:"
    echo "   ‚Ä¢ npm run test:regression:debug    (detailed analysis)"
    echo "   ‚Ä¢ npm run test:regression:fix      (auto-fix if possible)"
    echo "   ‚Ä¢ npm run test:regression:core     (run core tests only)"
    echo ""
    echo "‚ö†Ô∏è  DO NOT use --no-verify to bypass these tests!"
    echo "    Broken functionality affects the entire team."
    echo ""
    echo "üí° Need help? Check: packages/agents/BUG-017-REGRESSION-SUITE.md"
    echo ""
    exit 1
fi